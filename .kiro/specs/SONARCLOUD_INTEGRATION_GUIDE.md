# SonarCloud Integration Guide for Beast Mode Packages

## üéØ Purpose
This guide documents how to replicate the SonarCloud integration from `beast-mailbox-core` across all new Beast Mode packages for automated code quality, coverage, and maintainability tracking.

## üìä SonarCloud Dashboard Overview (beast-mailbox-core)

**Live Dashboard**: https://sonarcloud.io/summary/new_code?id=nkllon_beast-mailbox-core

### Key Metrics (as of last analysis)
- **Quality Gate**: ‚úÖ Passed (Green)
- **Lines of Code**: 353
- **Coverage**: 90%+ (displayed on "Overall Code" tab)
- **Duplications**: 0.0% (Required: ‚â§ 3.0%)
- **Maintainability Rating**: A
- **Security Rating**: A
- **Reliability Rating**: A
- **New Issues**: 0
- **Accepted Issues**: 0
- **Documentation Density**: 52%

---

## üîß Required Files for SonarCloud Integration

### 1. `sonar-project.properties` (Project Root)

```properties
sonar.projectKey=nkllon_beast-mailbox-core
sonar.organization=nkllon

# Exclusions
sonar.exclusions=**/node_modules/**,**/__pycache__/**,**/venv/**,**/.venv/**,**/dist/**,**/build/**,**/*.egg-info/**,**/docs/**,**/prompts/**,**/steering/**

# Source and test directories
sonar.sources=src
sonar.tests=tests

# Python version
sonar.python.version=3.9,3.10,3.11,3.12

# Coverage report paths
sonar.python.coverage.reportPaths=coverage.xml
```

**Key Configuration Points:**
- `sonar.projectKey`: Unique identifier (format: `{org}_{package-name}`)
- `sonar.organization`: SonarCloud organization name (`nkllon`)
- `sonar.exclusions`: Exclude docs, generated files, build artifacts, prompts
- `sonar.sources`: Source code directory (`src/`)
- `sonar.tests`: Test directory (`tests/`)
- `sonar.python.coverage.reportPaths`: Coverage XML file generated by pytest-cov

---

### 2. `.github/workflows/sonarcloud.yml` (GitHub Actions Workflow)

```yaml
name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync --all-extras

      - name: Run tests with coverage
        run: |
          uv run pytest --cov=src --cov-report=xml --cov-report=term

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_SCANNER_OPTS: -Dsonar.branch.name=master
```

**Critical Workflow Steps:**
1. **Checkout**: Fetch full git history (`fetch-depth: 0`) for accurate analysis
2. **Python Setup**: Use Python 3.12 (latest supported version)
3. **Dependencies**: Install via `uv sync --all-extras`
4. **Tests with Coverage**: **MUST run BEFORE SonarCloud scan** to generate `coverage.xml`
5. **SonarCloud Scan**: Uses `SONAR_TOKEN` secret, maps `main` ‚Üí `master` branch

**‚ö†Ô∏è Critical: Coverage XML Must Exist Before Scan**
- SonarCloud will not compute coverage if `coverage.xml` doesn't exist
- Always run tests with `--cov-report=xml` BEFORE the SonarCloud scan step

---

### 3. `pyproject.toml` (Pytest Coverage Configuration)

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
pythonpath = ["src"]
addopts = [
    "-v",
    "--strict-markers",
    "--cov=src",
    "--cov-report=term-missing",
    "--cov-report=html",
    "--cov-report=xml",           # For SonarCloud
]
markers = [
    "unit: Unit tests",
    "integration: Integration tests",
]
```

**Key Coverage Options:**
- `--cov=src`: Measure coverage for `src/` directory
- `--cov-report=xml`: Generate `coverage.xml` for SonarCloud
- `--cov-report=term-missing`: Show missing lines in terminal
- `--cov-report=html`: Generate HTML report for local review

---

## üöÄ Setup Instructions for New Packages

### Step 1: Create SonarCloud Project

1. Go to https://sonarcloud.io/projects/create
2. Select "nkllon" organization
3. Choose GitHub repository (e.g., `nkllon/beast-agent`)
4. SonarCloud will auto-create project key: `nkllon_beast-agent`
5. **Set Quality Gate**: Administration ‚Üí Quality Gates ‚Üí Select "Sonar way" (default)

### Step 2: Configure Secrets

1. Go to GitHub repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
2. Add `SONAR_TOKEN`:
   - Get token from SonarCloud: My Account ‚Üí Security ‚Üí Generate Tokens
   - Token Type: "User Token"
   - Name: `beast-agent-sonar` (or similar)
   - Copy token and add as GitHub secret
3. `GITHUB_TOKEN` is automatically provided by GitHub Actions

### Step 3: Create Configuration Files

1. Create `sonar-project.properties` in project root (see template above)
2. Update `sonar.projectKey` to match your package (e.g., `nkllon_beast-agent`)
3. Create `.github/workflows/sonarcloud.yml` (see template above)
4. Update `pyproject.toml` with pytest coverage options (see template above)

### Step 4: Set New Code Period (via API)

**Why:** SonarCloud defaults to "previous version" for new code period, which doesn't work for continuous development.

```bash
curl -X POST "https://sonarcloud.io/api/settings/set" \
  -d "key=sonar.leak.period" \
  -d "value=30" \
  -d "component=nkllon_beast-agent" \
  -H "Authorization: Bearer $SONAR_TOKEN"
```

**Explanation:**
- `sonar.leak.period=30`: New code = last 30 days
- Must be set via API (not configurable in `sonar-project.properties`)
- Enables "New Code" quality gate conditions

### Step 5: Map Git Branch to SonarCloud

**Problem:** Git uses `main`, SonarCloud defaults to `master`

**Solution:** Explicitly map branch in GitHub Actions workflow:

```yaml
- name: SonarCloud Scan
  uses: SonarSource/sonarqube-scan-action@v6
  env:
    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    SONAR_SCANNER_OPTS: -Dsonar.branch.name=master  # Maps Git's "main" to SonarCloud's "master"
```

**‚ö†Ô∏è Do NOT set `sonar.branch.name` in `sonar-project.properties`** - it breaks main branch analysis.

### Step 6: Test the Integration

1. Push a commit to `main` branch
2. GitHub Actions will trigger SonarCloud workflow
3. Check workflow run: https://github.com/nkllon/beast-agent/actions
4. Verify SonarCloud analysis: https://sonarcloud.io/dashboard?id=nkllon_beast-agent
5. Confirm Quality Gate passed and badges work

---

## üìä SonarCloud Quality Gates

### Default "Sonar way" Quality Gate Conditions

**On New Code:**
- Coverage ‚â• 80%
- Duplications ‚â§ 3.0%
- Maintainability Rating ‚â• A
- Reliability Rating ‚â• A
- Security Rating ‚â• A
- Security Hotspots Reviewed = 100%

**On Overall Code:**
- No conditions (only new code is enforced)

**beast-mailbox-core Achievement:**
- ‚úÖ Coverage: 90%+ (exceeds 80% requirement)
- ‚úÖ Duplications: 0.0% (well under 3.0%)
- ‚úÖ Maintainability Rating: A
- ‚úÖ 0 New Issues
- ‚úÖ 0 Accepted Issues

---

## üéØ Badges for README.md

### Required Badges (from beast-mailbox-core)

```markdown
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=nkllon_YOUR-PROJECT-KEY&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=nkllon_YOUR-PROJECT-KEY)
[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=nkllon_YOUR-PROJECT-KEY&metric=coverage)](https://sonarcloud.io/summary/new_code?id=nkllon_YOUR-PROJECT-KEY)
[![SonarQube Cloud](https://sonarcloud.io/images/project_badges/sonarcloud-dark.svg)](https://sonarcloud.io/summary/new_code?id=nkllon_YOUR-PROJECT-KEY)
[![Documentation](https://img.shields.io/badge/docs-X%25-brightgreen)](https://sonarcloud.io/summary/new_code?id=nkllon_YOUR-PROJECT-KEY)
[![Maintainability Rating](https://img.shields.io/badge/maintainability-A-brightgreen)](https://sonarcloud.io/summary/new_code?id=nkllon_YOUR-PROJECT-KEY)
```

**Replace `YOUR-PROJECT-KEY` with your project key (e.g., `beast-agent`).**

---

## üõ†Ô∏è Troubleshooting

### Coverage Not Showing in SonarCloud

**Symptom:** SonarCloud shows "No coverage data" or "There are not enough lines to compute coverage"

**Root Cause:** Tests not run before SonarCloud scan ‚Üí `coverage.xml` doesn't exist

**Fix:**
1. Ensure tests are run BEFORE SonarCloud scan in workflow
2. Verify `coverage.xml` is generated: `ls -la coverage.xml`
3. Check `sonar-project.properties` has correct path: `sonar.python.coverage.reportPaths=coverage.xml`

### Quality Gate Failing

**Symptom:** Quality Gate shows "Failed" (red)

**Root Cause:** One or more conditions not met (coverage < 80%, duplications > 3.0%, etc.)

**Fix:**
1. Check SonarCloud dashboard for specific failing condition
2. Click on failing metric to see details
3. Fix code quality issues or increase test coverage
4. Re-run CI/CD pipeline

### Branch Mapping Issues

**Symptom:** Badges show "unknown" or main branch not recognized

**Root Cause:** Git `main` not mapped to SonarCloud `master`

**Fix:**
1. Add `SONAR_SCANNER_OPTS: -Dsonar.branch.name=master` to workflow
2. **Do NOT** set `sonar.branch.name` in `sonar-project.properties`

### False Positives

**Symptom:** SonarCloud flags legitimate code as issues

**Fix:**
1. Review issue in SonarCloud dashboard
2. If false positive, mark as "Won't Fix" or "False Positive" in SonarCloud UI
3. Add `# noqa` comment with explanation in code (as last resort)
4. Document in `docs/SONARCLOUD_QUALITY_FIXES.md` (see beast-mailbox-core example)

---

## üìö Additional Resources

### beast-mailbox-core Reference Documentation
- `docs/SONARCLOUD_QUALITY_FIXES.md` - Quality issue remediation
- `docs/SONARCLOUD_FINAL_STEP.md` - Manual quality gate assignment
- `docs/LESSONS_LEARNED_v0.3.0.md` - SonarCloud integration lessons

### Official SonarCloud Docs
- SonarCloud GitHub Integration: https://docs.sonarcloud.io/advanced-setup/ci-based-analysis/github-actions/
- Python Analysis: https://docs.sonarcloud.io/enriching/languages/python/
- Quality Gates: https://docs.sonarcloud.io/improving/quality-gates/

---

## ‚úÖ Checklist for New Packages

- [ ] SonarCloud project created (https://sonarcloud.io/projects)
- [ ] Quality Gate assigned ("Sonar way")
- [ ] `SONAR_TOKEN` added to GitHub Secrets
- [ ] `sonar-project.properties` created and configured
- [ ] `.github/workflows/sonarcloud.yml` created
- [ ] `pyproject.toml` has pytest coverage options
- [ ] New code period set via API (`sonar.leak.period=30`)
- [ ] Branch mapping configured (`SONAR_SCANNER_OPTS: -Dsonar.branch.name=master`)
- [ ] First commit pushed to trigger analysis
- [ ] Quality Gate passed (green checkmark)
- [ ] Badges added to `README.md`
- [ ] Coverage XML generated before scan
- [ ] All metrics visible on SonarCloud dashboard

---

**Last Updated**: 2025-01-30  
**Reference Project**: [beast-mailbox-core](https://github.com/nkllon/beast-mailbox-core)  
**SonarCloud Organization**: [nkllon](https://sonarcloud.io/organizations/nkllon/projects)

